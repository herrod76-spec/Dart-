<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PRO SCORER - AWO KV Wesel</title>
    
    <!-- App Icon & Web App Meta -->
    <link rel="apple-touch-icon" href="image.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ProScorer">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --awo-red: #ef4444;
            --bg-dark: #0f172a;
        }
        body {
            background-color: var(--bg-dark);
            color: #f8fafc;
            font-family: -apple-system, system-ui, sans-serif;
            touch-action: manipulation;
            padding-top: env(safe-area-inset-top);
        }
        /* Mobile Optimierung für iPad Pro */
        .key-btn {
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border-radius: 12px;
            background: #1e293b;
            -webkit-tap-highlight-color: transparent;
            font-size: 1.25rem;
        }
        .key-btn:active { background: var(--awo-red); transform: scale(0.95); }
        .active-mod { background: var(--awo-red) !important; color: white; }
        .player-card { transition: all 0.3s ease; border-width: 4px; }
        .player-active { border-color: var(--awo-red) !important; background-color: #1e293b !important; opacity: 1 !important; transform: scale(1.02); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Checkbox Fix für iOS */
        select { -webkit-appearance: none; appearance: none; }
    </style>
</head>
<body class="p-2 md:p-4">

    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
            <div class="flex items-center gap-3">
                <!-- Fallback Icon falls image.png nicht lädt -->
                <div class="w-10 h-10 rounded-lg bg-red-600 flex items-center justify-center shadow-lg overflow-hidden">
                    <img src="image.png" alt="AWO" onerror="this.style.display='none'" class="w-full h-full object-cover">
                    <span class="text-white font-black text-xs">AWO</span>
                </div>
                <div>
                    <h1 class="text-xl font-black text-red-500 leading-none">PRO SCORER</h1>
                    <p class="text-[8px] text-slate-500 uppercase tracking-tighter">AWO KV Wesel | iPad Pro M5</p>
                </div>
            </div>

            <!-- Setup -->
            <div class="flex gap-2 bg-slate-800 p-1 rounded-xl overflow-x-auto no-scrollbar">
                <select id="player-count" onchange="setupPlayers()" class="bg-slate-700 text-white text-xs font-bold px-3 py-1 rounded-lg outline-none">
                    <option value="1">1 Spieler</option>
                    <option value="2" selected>2 Spieler</option>
                    <option value="3">3 Spieler</option>
                    <option value="4">4 Spieler</option>
                    <option value="5">5 Spieler</option>
                    <option value="6">6 Spieler</option>
                </select>
                <button onclick="setMode('301')" id="tab-301" class="px-3 py-1 text-[10px] font-bold uppercase border-b-2 border-transparent transition-all">301</button>
                <button onclick="setMode('501')" id="tab-501" class="px-3 py-1 text-[10px] font-bold uppercase border-b-2 border-red-500 text-red-500 transition-all">501</button>
                <button onclick="setMode('highscore')" id="tab-highscore" class="px-3 py-1 text-[10px] font-bold uppercase border-b-2 border-transparent transition-all">Highscore</button>
                <button onclick="setMode('shanghai')" id="tab-shanghai" class="px-3 py-1 text-[10px] font-bold uppercase border-b-2 border-transparent transition-all">Shanghai</button>
            </div>
        </div>

        <!-- Player Grid -->
        <div id="player-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 mb-6"></div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Left Side: Input -->
            <div class="lg:col-span-3 space-y-4">
                <div class="flex items-center justify-between bg-slate-800/50 p-4 rounded-2xl border border-slate-700">
                    <div class="flex gap-3" id="turn-darts">
                        <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center font-bold border border-slate-600">-</div>
                        <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center font-bold border border-slate-600">-</div>
                        <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center font-bold border border-slate-600">-</div>
                    </div>
                    <div class="text-right">
                        <span id="round-label" class="text-[10px] text-slate-500 uppercase font-bold tracking-widest">Runde 1</span>
                        <div id="turn-total" class="text-3xl font-black text-red-500">0</div>
                    </div>
                </div>

                <div class="flex gap-2">
                    <button onclick="setMultiplier(1)" id="btn-s" class="flex-1 py-4 bg-slate-700 rounded-xl font-bold active-mod">Single</button>
                    <button onclick="setMultiplier(2)" id="btn-d" class="flex-1 py-4 bg-slate-700 rounded-xl font-bold">Double</button>
                    <button onclick="setMultiplier(3)" id="btn-t" class="flex-1 py-4 bg-slate-700 rounded-xl font-bold">Triple</button>
                </div>

                <div class="grid grid-cols-5 gap-2" id="numpad"></div>

                <div class="grid grid-cols-4 gap-2">
                    <button onclick="hit(0)" class="bg-slate-600 py-6 rounded-xl font-black text-lg">MISS</button>
                    <button onclick="hit(25)" class="bg-orange-600 py-6 rounded-xl font-black text-lg">BULL</button>
                    <button onclick="undo()" class="bg-slate-800 py-6 rounded-xl font-bold text-slate-400">UNDO</button>
                    <button onclick="resetGame()" class="bg-slate-950 py-6 rounded-xl font-bold text-red-900">RESET</button>
                </div>
            </div>

            <!-- Right Side: Utils -->
            <div class="space-y-4">
                <div class="bg-slate-800 p-5 rounded-2xl border border-slate-700">
                    <h3 class="text-xs font-black mb-4 text-slate-400 uppercase tracking-widest">Leg-Siege</h3>
                    <div id="legs-stats" class="space-y-2"></div>
                </div>
                <button onclick="copyToNumbers()" class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 rounded-2xl text-xs font-bold transition-colors">
                    Statistik für Numbers kopieren
                </button>
            </div>
        </div>
    </div>

    <script>
        let gameState = {
            mode: '501',
            players: [],
            activeIdx: 0,
            multiplier: 1,
            round: 1,
            turnDarts: [],
            history: []
        };

        function setupPlayers(keepLegs = false) {
            const count = parseInt(document.getElementById('player-count').value);
            const oldLegs = gameState.players.map(p => p.legs);
            
            gameState.players = Array.from({length: count}, (_, i) => ({
                id: i + 1,
                score: getInitialScore(),
                throws: [],
                legs: (keepLegs && oldLegs[i]) ? oldLegs[i] : 0
            }));
            
            gameState.activeIdx = 0;
            gameState.round = 1;
            gameState.turnDarts = [];
            renderPlayers();
            updateUI();
        }

        function getInitialScore() {
            if (gameState.mode === 'highscore' || gameState.mode === 'shanghai') return 0;
            return parseInt(gameState.mode) || 501;
        }

        function setMode(m) {
            gameState.mode = m;
            document.querySelectorAll('[id^="tab-"]').forEach(t => {
                t.classList.remove('text-red-500', 'border-red-500');
                t.classList.add('border-transparent');
            });
            document.getElementById(`tab-${m}`).classList.add('text-red-500', 'border-red-500');
            setupPlayers(false);
        }

        function renderPlayers() {
            const grid = document.getElementById('player-grid');
            const legBox = document.getElementById('legs-stats');
            grid.innerHTML = '';
            legBox.innerHTML = '';
            
            gameState.players.forEach((p, i) => {
                const card = document.createElement('div');
                card.id = `p-card-${i}`;
                card.className = `player-card p-3 rounded-2xl border-2 transition-all duration-300`;
                card.innerHTML = `
                    <div class="flex justify-between text-[8px] font-bold text-slate-500">
                        <span>P${p.id}</span>
                        <span>Legs: ${p.legs}</span>
                    </div>
                    <div id="p-score-${i}" class="text-3xl font-black my-1 text-white tabular-nums">${p.score}</div>
                    <div class="text-[8px] text-slate-400 flex justify-between">
                        <span>AVG: <span id="p-avg-${i}">0</span></span>
                        <span>Darts: <span id="p-darts-${i}">0</span></span>
                    </div>
                `;
                grid.appendChild(card);

                const legRow = document.createElement('div');
                legRow.className = "flex justify-between text-[10px] border-b border-slate-700 pb-1";
                legRow.innerHTML = `<span class="text-slate-400">Spieler ${p.id}</span><span class="font-bold text-white">${p.legs}</span>`;
                legBox.appendChild(legRow);
            });
        }

        function hit(val) {
            const points = val * gameState.multiplier;
            if (val === 25 && gameState.multiplier === 3) return;

            gameState.history.push(JSON.parse(JSON.stringify(gameState)));
            const p = gameState.players[gameState.activeIdx];

            if (gameState.mode.includes('01')) {
                if (p.score - points >= 2 || p.score - points === 0) {
                    p.score -= points;
                    if (p.score === 0) {
                        p.legs++;
                        alert(`Spieler ${p.id} gewinnt das Leg!`);
                        setupPlayers(true); 
                        return;
                    }
                } else {
                    while(gameState.turnDarts.length < 2) gameState.turnDarts.push(0);
                }
            } else {
                p.score += points;
            }

            p.throws.push(points);
            gameState.turnDarts.push(points);

            if (gameState.turnDarts.length === 3) {
                setTimeout(nextPlayer, 300);
            } else {
                gameState.multiplier = 1;
                updateUI();
            }
        }

        function nextPlayer() {
            gameState.turnDarts = [];
            gameState.activeIdx++;
            if (gameState.activeIdx >= gameState.players.length) {
                gameState.activeIdx = 0;
                gameState.round++;
                if (gameState.mode === 'highscore' && gameState.round > 7) {
                    alert("Training beendet!");
                    setupPlayers(true); return;
                }
            }
            gameState.multiplier = 1;
            updateUI();
        }

        function updateUI() {
            gameState.players.forEach((p, i) => {
                const card = document.getElementById(`p-card-${i}`);
                if (i === gameState.activeIdx) {
                    card.classList.add('player-active');
                    card.classList.remove('bg-slate-800/40', 'border-transparent', 'opacity-60');
                } else {
                    card.classList.remove('player-active');
                    card.classList.add('bg-slate-800/40', 'border-transparent', 'opacity-60');
                }
                document.getElementById(`p-score-${i}`).innerText = p.score;
                document.getElementById(`p-darts-${i}`).innerText = p.throws.length;
                
                const avg = p.throws.length ? ((gameState.mode.includes('01') ? (getInitialScore() - p.score) : p.score) / (p.throws.length / 3)).toFixed(1) : "0.0";
                document.getElementById(`p-avg-${i}`).innerText = avg;
            });

            const dots = document.getElementById('turn-darts').children;
            for(let i=0; i<3; i++) {
                dots[i].innerText = gameState.turnDarts[i] !== undefined ? gameState.turnDarts[i] : "-";
                dots[i].className = `w-10 h-10 rounded-full flex items-center justify-center font-bold transition-colors ${gameState.turnDarts[i] !== undefined ? 'bg-red-500 text-white' : 'bg-slate-700 text-slate-500'}`;
            }

            document.getElementById('turn-total').innerText = gameState.turnDarts.reduce((a,b) => (typeof b === 'number' ? a+b : a), 0);
            document.getElementById('round-label').innerText = `Runde ${gameState.round}`;
            
            document.getElementById('btn-s').className = `flex-1 py-4 rounded-xl font-bold transition-all ${gameState.multiplier === 1 ? 'active-mod scale-105' : 'bg-slate-700'}`;
            document.getElementById('btn-d').className = `flex-1 py-4 rounded-xl font-bold transition-all ${gameState.multiplier === 2 ? 'active-mod scale-105' : 'bg-slate-700'}`;
            document.getElementById('btn-t').className = `flex-1 py-4 rounded-xl font-bold transition-all ${gameState.multiplier === 3 ? 'active-mod scale-105' : 'bg-slate-700'}`;
        }

        function setMultiplier(m) { gameState.multiplier = m; updateUI(); }
        function undo() { if (gameState.history.length) { gameState = gameState.history.pop(); updateUI(); } }
        function resetGame() { if(confirm("Spiel komplett zurücksetzen (inkl. Legs)?")) setupPlayers(false); }

        function copyToNumbers() {
            let csv = "Spieler;Score;Legs;Avg\n";
            gameState.players.forEach(p => {
                const avg = p.throws.length ? ((Math.abs(getInitialScore() - p.score)) / (p.throws.length / 3)).toFixed(1) : "0.0";
                csv += `${p.id};${p.score};${p.legs};${avg}\n`;
            });
            const el = document.createElement('textarea');
            el.value = csv;
            document.body.appendChild(el); el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            alert("Kopiert!");
        }

        const pad = document.getElementById('numpad');
        for(let i=1; i<=20; i++) {
            const b = document.createElement('button');
            b.className = 'key-btn';
            b.innerText = i;
            b.onclick = () => hit(i);
            pad.appendChild(b);
        }
        
        setupPlayers();
    </script>
</body>
</html>

