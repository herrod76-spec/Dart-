<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Henry Kapelly - Trainingsedition</title>
    
    <!-- Apple Home Screen Integration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HK Trainings">
    <link rel="apple-touch-icon" href="image.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #020617; margin: 0; overflow: hidden; -webkit-tap-highlight-color: transparent; color: white; font-family: ui-sans-serif, system-ui, sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(16px); border: 1px solid rgba(51, 65, 85, 0.5); }
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .analyzing { animation: pulse-red 2s infinite; }
        .logo-circle { width: 128px; height: 128px; border-radius: 50%; border: 4px solid #dc2626; object-fit: cover; background: white; cursor: pointer; }
        /* Sicherstellung der Touch-Größen für iPad */
        button { touch-action: manipulation; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        const apiKey = ""; 

        const TRAINING_CATEGORIES = {
            MATCH: {
                label: "Wettkampf-Modi",
                modes: {
                    SCORING_501: { name: "501 (Double Out)", startScore: 501, instruction: "Turnier-Standard. Beende auf 0 mit einem Doppel.", tips: "Fördert das mathematische Denken." },
                    SCORING_301: { name: "301 (Single Out)", startScore: 301, instruction: "Schneller Abschluss auf 0 mit beliebigem Feld.", tips: "Erfolgserlebnisse für Einsteiger." }
                }
            },
            EXERCISES: {
                label: "Gezielte Übungen",
                modes: {
                    BOBS_27: { name: "Bob's 27", startScore: 27, instruction: "Wirf auf Doppel 1 bis Bull. Treffer addieren, Fehlwürfe subtrahieren.", tips: "Training der Resilienz." },
                    AROUND_THE_CLOCK: { name: "Around The Clock", startScore: 0, instruction: "Triff Segmente 1 bis 20 nacheinander.", tips: "Fokus und Ausdauer." },
                    SHANGHAI: { name: "Shanghai", startScore: 0, instruction: "Triff Single, Double und Triple einer Zahl in einer Aufnahme.", tips: "Präzisionstraining." }
                }
            },
            ANALYSIS: {
                label: "Spezial-Analysen",
                modes: {
                    CATCH_121: { name: "121 Check (Analyse)", startScore: 121, instruction: "Checke 121 in max. 9 Darts (3 Aufnahmen). Ende auf Doppel.", tips: "Strategie-Check für Profis." }
                }
            }
        };

        function App() {
            const [view, setView] = useState('setup');
            const [logoUrl, setLogoUrl] = useState("./image.png");
            const [playerCount, setPlayerCount] = useState(1);
            const [selectedMode, setSelectedMode] = useState('BOBS_27');
            const [players, setPlayers] = useState([]);
            const [activeIdx, setActiveIdx] = useState(0);
            const [turnDarts, setTurnDarts] = useState([]);
            const [multiplier, setMultiplier] = useState(1);
            const [showHelp, setShowHelp] = useState(false);
            const [aiAnalysis, setAiAnalysis] = useState("");
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const fileInputRef = useRef(null);

            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [view, showHelp, aiAnalysis, turnDarts, logoUrl]);

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        setLogoUrl(ev.target.result);
                        // Versuche das Apple Touch Icon dynamisch zu aktualisieren
                        let link = document.querySelector("link[rel*='apple-touch-icon']");
                        if (link) link.href = ev.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };

            const currentModeData = useMemo(() => {
                for (const cat in TRAINING_CATEGORIES) {
                    if (TRAINING_CATEGORIES[cat].modes[selectedMode]) return TRAINING_CATEGORIES[cat].modes[selectedMode];
                }
                return TRAINING_CATEGORIES.EXERCISES.modes.BOBS_27;
            }, [selectedMode]);

            const initGame = () => {
                setPlayers(Array.from({ length: playerCount }, (_, i) => ({
                    id: i, name: `Spieler ${i + 1}`, score: currentModeData.startScore, step: 1, isGameOver: false
                })));
                setView('playing');
            };

            const getAIAdvice = async () => {
                setIsAnalyzing(true);
                const p = players[activeIdx];
                const prompt = `Analysiere als Dipl. Sozialpädagoge der AWO KV Wesel: Henry Kapelly (Score: ${p.score}, Modus: ${currentModeData.name}). Gib einen kurzen, motivierenden Tipp (max. 15 Wörter).`;
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await res.json();
                    setAiAnalysis(data.candidates?.[0]?.content?.parts?.[0]?.text || "Fokus!");
                } catch { setAiAnalysis("Konzentration ist alles!"); }
                setIsAnalyzing(false);
            };

            const processTurn = useCallback(() => {
                const updated = [...players];
                const p = updated[activeIdx];
                const turnSum = turnDarts.reduce((acc, d) => acc + (d.v * d.m), 0);
                const lastDart = turnDarts[turnDarts.length - 1];

                if (selectedMode === 'BOBS_27') {
                    const target = p.step === 21 ? 25 : p.step;
                    const hits = turnDarts.filter(d => d.v === target && d.m === 2).length;
                    p.score += hits > 0 ? (hits * target * 2) : -(target * 2);
                    p.step++;
                    if (p.score <= 0 || p.step > 21) p.isGameOver = true;
                } 
                else if (selectedMode === 'AROUND_THE_CLOCK') {
                    turnDarts.forEach(d => { if(d.v === p.step) p.step++; });
                    p.score = p.step - 1;
                    if (p.step > 20) p.isGameOver = true;
                }
                else if (selectedMode === 'CATCH_121') {
                    if (turnSum === p.score && lastDart.m === 2) { p.score = 0; p.isGameOver = true; }
                    else if (turnSum < p.score && (p.score - turnSum) > 1) p.score -= turnSum;
                    p.step++;
                    if (p.step > 3 && p.score > 0) p.isGameOver = true;
                }
                else {
                    if (turnSum === p.score) {
                        if (selectedMode === 'SCORING_501' && lastDart.m === 2) { p.score = 0; p.isGameOver = true; }
                        else if (selectedMode === 'SCORING_301') { p.score = 0; p.isGameOver = true; }
                    } else if (turnSum < p.score) {
                        const remaining = p.score - turnSum;
                        if (selectedMode === 'SCORING_501' && remaining > 1) p.score = remaining;
                        else if (selectedMode === 'SCORING_301') p.score = remaining;
                    }
                }

                setPlayers(updated);
                setTurnDarts([]);
                setActiveIdx((activeIdx + 1) % playerCount);
            }, [turnDarts, players, activeIdx, selectedMode, playerCount]);

            useEffect(() => { if (turnDarts.length === 3) setTimeout(processTurn, 600); }, [turnDarts, processTurn]);

            if (view === 'setup') return (
                <div className="min-h-screen bg-slate-950 flex items-center justify-center p-6">
                    <div className="w-full max-w-xl bg-slate-900 border border-slate-800 rounded-[3.5rem] p-12 shadow-2xl text-center">
                        <input type="file" ref={fileInputRef} className="hidden" onChange={handleFileChange} accept="image/*" />
                        <img src={logoUrl} className="logo-circle mx-auto mb-6" onClick={() => fileInputRef.current.click()} />
                        <h1 className="text-4xl font-black italic uppercase tracking-tighter">Henry <span className="text-red-600">Kapelly</span></h1>
                        <p className="text-[11px] font-bold text-slate-500 uppercase tracking-[0.4em] mt-3 mb-10">AWO KV Wesel • Trainingsedition</p>
                        
                        <div className="space-y-8 text-left">
                            <section>
                                <div className="flex justify-between items-center mb-4">
                                    <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Training / Analyse</label>
                                    <button onClick={() => setShowHelp(true)} className="text-red-500 text-[10px] font-black uppercase flex items-center gap-1"><i data-lucide="info" size={12}></i> Hilfe</button>
                                </div>
                                <select value={selectedMode} onChange={e => setSelectedMode(e.target.value)} className="w-full p-6 bg-slate-800 rounded-3xl border-2 border-slate-700 font-bold text-xl outline-none">
                                    {Object.entries(TRAINING_CATEGORIES).map(([ck, cat]) => (
                                        <optgroup key={ck} label={cat.label}>
                                            {Object.entries(cat.modes).map(([mk, m]) => <option key={mk} value={mk}>{m.name}</option>)}
                                        </optgroup>
                                    ))}
                                </select>
                            </section>
                            <section>
                                <label className="text-[10px] font-black text-slate-500 uppercase block mb-4 tracking-widest">Spieler</label>
                                <div className="grid grid-cols-6 gap-3">
                                    {[1, 2, 3, 4, 5, 6].map(n => (
                                        <button key={n} onClick={() => setPlayerCount(n)} className={`py-5 rounded-2xl font-black text-xl transition-all ${playerCount === n ? 'bg-red-600 shadow-lg scale-110' : 'bg-slate-800 text-slate-500'}`}>{n}</button>
                                    ))}
                                </div>
                            </section>
                            <button onClick={initGame} className="w-full py-7 bg-white text-black rounded-[2rem] font-black text-3xl uppercase hover:bg-red-600 hover:text-white transition-all shadow-xl">Starten</button>
                        </div>
                    </div>
                    {showHelp && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-6">
                            <div className="absolute inset-0 bg-black/90 backdrop-blur-md" onClick={() => setShowHelp(false)}></div>
                            <div className="glass w-full max-w-xl p-12 rounded-[4rem] relative z-10">
                                <h2 className="text-3xl font-black uppercase italic mb-6 text-red-500 tracking-tighter">{currentModeData.name}</h2>
                                <p className="text-xl mb-6 font-medium text-slate-200">{currentModeData.instruction}</p>
                                <div className="p-8 bg-red-600/10 rounded-3xl border border-red-500/20">
                                    <p className="text-sm italic font-bold leading-relaxed">AWO-Tipp: {currentModeData.tips}</p>
                                </div>
                                <button onClick={() => setShowHelp(false)} className="w-full mt-8 py-5 bg-white text-black rounded-3xl font-black uppercase">Schließen</button>
                            </div>
                        </div>
                    )}
                </div>
            );

            return (
                <div className="h-screen bg-slate-950 flex flex-col overflow-hidden">
                    <header className="px-10 py-5 bg-slate-900/50 flex justify-between items-center border-b border-white/5 shrink-0">
                        <div className="flex items-center gap-4">
                            <img src={logoUrl} className="w-10 h-10 rounded-full border border-red-600 object-cover" />
                            <span className="font-black italic uppercase text-lg tracking-tighter">HK <span className="text-red-600">Train</span></span>
                        </div>
                        <button onClick={getAIAdvice} className={`px-8 py-3 rounded-full border border-red-600 text-[10px] font-black uppercase tracking-widest flex items-center gap-2 ${isAnalyzing ? 'analyzing' : ''}`}>
                            <i data-lucide="sparkles" size={14}></i> Analyse
                        </button>
                        <button onClick={() => setView('setup')} className="text-slate-500 hover:text-white transition-colors"><i data-lucide="home"></i></button>
                    </header>

                    <div className="flex-1 flex overflow-hidden">
                        <aside className="w-72 border-r border-white/5 p-6 space-y-4 bg-black/20 overflow-y-auto">
                            {players.map((p, idx) => (
                                <div key={p.id} className={`p-6 rounded-[2.5rem] border-2 transition-all ${idx === activeIdx ? 'border-red-600 bg-red-600/10 scale-105 shadow-2xl' : 'border-transparent opacity-20'}`}>
                                    <div className="flex justify-between items-center mb-1">
                                        <div className="text-[9px] font-black text-slate-500 uppercase">{p.name}</div>
                                        {selectedMode === 'CATCH_121' && <div className="text-[9px] font-bold text-red-500 uppercase">A{p.step}/3</div>}
                                    </div>
                                    <div className="text-4xl font-black italic tracking-tighter">{p.score}</div>
                                </div>
                            ))}
                        </aside>

                        <main className="flex-1 flex flex-col items-center justify-center p-10 relative">
                            {aiAnalysis && (
                                <div className="absolute top-6 glass p-8 rounded-[3rem] border-red-600/40 w-[90%] max-w-xl shadow-2xl z-50 animate-bounce flex items-center gap-6">
                                    <img src={logoUrl} className="w-16 h-16 rounded-2xl border border-red-600" />
                                    <div className="flex-1 text-white">
                                        <div className="text-[10px] font-black text-red-500 uppercase mb-1 tracking-widest">Henry Kapelly</div>
                                        <p className="font-bold italic leading-tight">{aiAnalysis}</p>
                                    </div>
                                    <button onClick={() => setAiAnalysis("")} className="text-slate-500"><i data-lucide="x"></i></button>
                                </div>
                            )}

                            <div className="text-[16rem] font-black italic tracking-tighter leading-none mb-10 drop-shadow-[0_20px_50px_rgba(220,38,38,0.2)]">
                                {players[activeIdx]?.score}
                            </div>

                            <div className="flex gap-4 mb-12">
                                {[0,1,2].map(i => (
                                    <div key={i} className={`w-24 h-32 rounded-3xl border-4 flex items-center justify-center text-5xl font-black transition-all ${turnDarts[i] ? 'bg-red-600 border-red-400 scale-105' : 'bg-slate-900 border-slate-800 opacity-20'}`}>
                                        {turnDarts[i] ? `${turnDarts[i].m === 2 ? 'D' : turnDarts[i].m === 3 ? 'T' : ''}${turnDarts[i].v === 25 ? 'B' : turnDarts[i].v}` : ''}
                                    </div>
                                ))}
                            </div>

                            <div className="w-full max-w-2xl grid grid-cols-4 gap-4">
                                <div className="flex flex-col gap-2">
                                    {[1, 2, 3].map(m => (
                                        <button key={m} onClick={() => setMultiplier(m)} className={`flex-1 rounded-2xl font-black border-2 transition-all ${multiplier === m ? 'bg-white text-black border-white' : 'bg-slate-900 border-slate-800 text-slate-600 text-[10px] uppercase tracking-widest'}`}>
                                            {m === 1 ? 'S' : m === 2 ? 'D' : 'T'}
                                        </button>
                                    ))}
                                </div>
                                <div className="col-span-3 grid grid-cols-7 gap-2">
                                    {[20, 19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1].map(n => (
                                        <button key={n} onClick={() => { if(turnDarts.length < 3) setTurnDarts([...turnDarts, {v:n, m:multiplier}]); setMultiplier(1); }} className="bg-slate-900 border border-white/5 py-6 rounded-2xl font-black text-2xl active:bg-red-600 transition-all">{n}</button>
                                    ))}
                                    <button onClick={() => { if(turnDarts.length < 3) setTurnDarts([...turnDarts, {v:25, m:multiplier}]); setMultiplier(1); }} className="bg-red-900/40 text-red-500 rounded-2xl font-black text-xs">BULL</button>
                                    <button onClick={() => { if(turnDarts.length < 3) setTurnDarts([...turnDarts, {v:0, m:1}]); setMultiplier(1); }} className="bg-slate-950 text-slate-800 rounded-2xl font-black text-[10px] uppercase tracking-tighter">MISS</button>
                                </div>
                            </div>
                        </main>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

