<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="apple-touch-icon" href="image.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>DART PRO AI - AWO KV Wesel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --accent: #ef4444; --bg: #020617; }
        body { background-color: var(--bg); color: #f8fafc; font-family: 'Inter', sans-serif; touch-action: manipulation; overflow: hidden; height: 100vh; }
        
        .view-ipad { flex-direction: row; }
        .view-iphone { flex-direction: column; }
        
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.1); }
        .setup-card { background: #1e293b; border: 2px solid #334155; transition: 0.2s; cursor: pointer; }
        .setup-card.selected { border-color: var(--accent); background: #2d3748; box-shadow: 0 0 20px rgba(239, 68, 68, 0.2); }
        
        .key-btn { aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; font-weight: 900; border-radius: 12px; background: #1e293b; border: 1px solid #334155; cursor: pointer; }
        .active-mod { background: var(--accent) !important; color: white; border-color: white !important; }
        
        .player-card { background: #0f172a; padding: 12px; border-radius: 16px; border: 2px solid transparent; transition: 0.3s; }
        .player-card.active { border-color: var(--accent); background: #1e293b; transform: scale(1.05); }

        #launcher { position: fixed; inset: 0; background: #020617; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        select { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1.2em; }
        
        .ai-glow { animation: ai-glow 3s infinite alternate; }
        @keyframes ai-glow { from { box-shadow: 0 0 5px rgba(239, 68, 68, 0.2); } to { box-shadow: 0 0 20px rgba(239, 68, 68, 0.5); } }
    </style>
</head>
<body class="flex" id="app-body">

    <!-- DEVICE SELECTOR (LAUNCHER) -->
    <div id="launcher">
        <div class="text-center mb-12">
            <h1 class="text-6xl font-black italic tracking-tighter">DART<span class="text-red-500">PRO</span> AI</h1>
            <p class="text-slate-500 text-xs font-bold uppercase tracking-[0.3em]">AWO KV Wesel ‚Ä¢ P√§dagogik Edition</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl px-6">
            <button onclick="boot('ipad')" class="p-10 glass rounded-[3rem] border-2 border-slate-700 hover:border-red-500 transition-all text-left group">
                <span class="text-4xl block mb-4 group-hover:scale-110 transition-transform">üíª</span>
                <span class="text-2xl font-black block text-white">iPad Pro / Tablet</span>
                <span class="text-slate-400 text-sm">Vollst√§ndiges Dashboard-Layout</span>
            </button>
            <button onclick="boot('iphone')" class="p-10 glass rounded-[3rem] border-2 border-slate-700 hover:border-red-500 transition-all text-left group">
                <span class="text-4xl block mb-4 group-hover:scale-110 transition-transform">üì±</span>
                <span class="text-2xl font-black block text-white">iPhone / Handy</span>
                <span class="text-slate-400 text-sm">Optimierter mobiler Scorer</span>
            </button>
        </div>
    </div>

    <!-- AI HEADER -->
    <div id="ai-top-bar" class="hidden fixed top-0 left-0 right-0 z-[100] glass px-6 py-2 flex justify-between items-center border-b border-red-500/20">
        <div class="flex items-center gap-3">
            <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
            <span id="ai-status-text" class="text-[10px] font-black uppercase text-red-500 tracking-widest">AI Mentor aktiv</span>
        </div>
        <div class="flex gap-2">
            <button onclick="openAIReport()" class="bg-red-600 text-white text-[9px] font-black px-3 py-1.5 rounded-full uppercase">Bericht</button>
            <button onclick="location.reload()" class="bg-slate-700 text-white text-[9px] font-black px-3 py-1.5 rounded-full uppercase">Reset</button>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto h-screen relative pt-14">
        
        <!-- PAGE 1: SETUP -->
        <section id="page-setup" class="p-6 lg:p-20 max-w-4xl mx-auto space-y-10">
            <header>
                <h2 class="text-5xl font-black italic uppercase tracking-tighter">New <span class="text-red-500">Session</span></h2>
                <p class="text-slate-400 text-sm font-bold uppercase mt-2">P√§dagogisches Setting konfigurieren</p>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Players -->
                <div class="space-y-4">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Teilnehmeranzahl</label>
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="setPlayerCount(1)" id="pc-1" class="setup-card p-4 rounded-xl font-black selected">1</button>
                        <button onclick="setPlayerCount(2)" id="pc-2" class="setup-card p-4 rounded-xl font-black">2</button>
                        <button onclick="setPlayerCount(3)" id="pc-3" class="setup-card p-4 rounded-xl font-black">3</button>
                        <button onclick="setPlayerCount(4)" id="pc-4" class="setup-card p-4 rounded-xl font-black">4</button>
                    </div>
                </div>

                <!-- Mode Dropdown -->
                <div class="space-y-4">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Spielmodus</label>
                    <select id="mode-select" class="w-full p-4 glass rounded-xl font-bold text-white outline-none">
                        <optgroup label="Klassisch">
                            <option value="501">üèÜ 501 (Double Out)</option>
                            <option value="301">üèÜ 301 (Single Out)</option>
                            <option value="highscore">üìà Highscore (30 Darts)</option>
                        </optgroup>
                        <optgroup label="P√§dagogisch / Training">
                            <option value="atc">‚è±Ô∏è Around The Clock (Grob-Motorik)</option>
                            <option value="killer">üó°Ô∏è Killer (Frustrationstoleranz)</option>
                            <option value="elimination">üö´ Elimination (Taktik/Druck)</option>
                            <option value="bobs27">üìâ Bob's 27 (Fokus Double)</option>
                        </optgroup>
                    </select>
                </div>

                <!-- AI Focus Selector -->
                <div class="space-y-4 md:col-span-2">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest text-center block">KI Beobachtungs-Fokus</label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <button onclick="setAIFocus('impulskontrolle')" id="ai-f-1" class="setup-card p-4 rounded-xl font-bold text-sm selected">Impulskontrolle</button>
                        <button onclick="setAIFocus('frustration')" id="ai-f-2" class="setup-card p-4 rounded-xl font-bold text-sm">Frustrationstoleranz</button>
                        <button onclick="setAIFocus('motorik')" id="ai-f-3" class="setup-card p-4 rounded-xl font-bold text-sm">Motorik & Fokus</button>
                    </div>
                </div>
            </div>

            <button onclick="startGame()" class="w-full py-6 bg-white text-black font-black rounded-2xl uppercase tracking-widest text-xl hover:bg-red-500 hover:text-white transition-all">Einheit Starten</button>
        </section>

        <!-- PAGE 2: GAME -->
        <section id="page-game" class="hidden p-4 lg:p-10 space-y-6">
            <div id="player-grid" class="grid grid-cols-2 lg:grid-cols-4 gap-3"></div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Scorer -->
                <div class="lg:col-span-2 space-y-4">
                    <div class="glass p-6 rounded-[2rem] flex justify-between items-center relative overflow-hidden ai-glow">
                        <div id="checkout-help" class="absolute top-2 left-6 text-[9px] font-black text-red-500 uppercase"></div>
                        <div class="flex gap-2" id="dart-previews">
                            <div class="w-12 h-12 lg:w-16 lg:h-16 glass rounded-xl flex items-center justify-center font-black text-2xl">-</div>
                            <div class="w-12 h-12 lg:w-16 lg:h-16 glass rounded-xl flex items-center justify-center font-black text-2xl">-</div>
                            <div class="w-12 h-12 lg:w-16 lg:h-16 glass rounded-xl flex items-center justify-center font-black text-2xl">-</div>
                        </div>
                        <div class="text-right">
                            <h3 id="turn-score" class="text-6xl lg:text-7xl font-black italic tabular-nums">0</h3>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setMult(1)" id="mod-1" class="py-3 glass rounded-xl font-black active-mod">SINGLE</button>
                        <button onclick="setMult(2)" id="mod-2" class="py-3 glass rounded-xl font-black">DOUBLE</button>
                        <button onclick="setMult(3)" id="mod-3" class="py-3 glass rounded-xl font-black">TRIPLE</button>
                    </div>

                    <div id="numpad" class="grid grid-cols-5 md:grid-cols-7 gap-1.5"></div>

                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="hit(0)" class="bg-slate-800 py-5 rounded-xl font-black text-sm uppercase">Miss</button>
                        <button onclick="hit(25)" class="bg-red-700 py-5 rounded-xl font-black text-sm uppercase">Bull</button>
                        <button onclick="undo()" class="bg-slate-900 border border-slate-700 py-5 rounded-xl font-bold text-xs text-slate-500">Undo</button>
                    </div>
                </div>

                <!-- Info Column -->
                <div class="space-y-4">
                    <div class="glass p-6 rounded-2xl text-center">
                        <div id="timer-label" class="text-[9px] font-black text-slate-500 uppercase mb-1">Session Timer</div>
                        <div id="session-timer" class="text-3xl font-black text-red-500 tabular-nums">45:00</div>
                    </div>
                    <div class="glass p-4 rounded-2xl h-48 lg:h-64">
                        <canvas id="game-chart"></canvas>
                    </div>
                    <div class="bg-red-900/10 border border-red-500/20 p-4 rounded-2xl">
                        <p class="text-[9px] font-black text-red-500 uppercase mb-2">KI Fokus-Check</p>
                        <p id="ai-live-note" class="text-xs text-slate-300 italic">Beobachte Wurfrhythmus...</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- REPORT MODAL -->
    <div id="report-modal" class="fixed inset-0 bg-black/95 hidden z-[3000] flex items-center justify-center p-4 lg:p-12">
        <div class="bg-slate-900 w-full max-w-2xl rounded-[2.5rem] p-8 border border-slate-800 overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-black italic tracking-tighter uppercase">KI <span class="text-red-500">Analyse</span></h2>
                <button onclick="closeReport()" class="text-slate-500 text-3xl">&times;</button>
            </div>
            <div id="report-content" class="text-slate-300 space-y-4 text-sm leading-relaxed">
                <div class="flex items-center gap-3"><div class="animate-spin w-4 h-4 border-2 border-red-500 border-t-transparent rounded-full"></div> Berichtsdaten werden zusammengestellt...</div>
            </div>
            <div class="mt-8 grid grid-cols-2 gap-4">
                <button onclick="window.print()" class="py-4 glass rounded-xl font-black uppercase text-xs">PDF Speichern</button>
                <button onclick="closeReport()" class="py-4 bg-red-600 rounded-xl font-black uppercase text-xs">Zur√ºck</button>
            </div>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        let config = { device: 'ipad', playerCount: 1, mode: '501', aiFocus: 'impulskontrolle' };
        let game = { players: [], activeIdx: 0, mult: 1, turn: [], timer: 45 * 60, interval: null, history: [] };
        let chart;

        function boot(device) {
            config.device = device;
            document.getElementById('launcher').style.display = 'none';
            document.getElementById('app-body').className = 'flex ' + (device === 'iphone' ? 'view-iphone' : 'view-ipad');
            initNumpad();
            initChart();
        }

        function setPlayerCount(n) {
            config.playerCount = n;
            document.querySelectorAll('[id^="pc-"]').forEach(b => b.classList.remove('selected'));
            document.getElementById('pc-'+n).classList.add('selected');
        }

        function setAIFocus(f) {
            config.aiFocus = f;
            document.querySelectorAll('[id^="ai-f-"]').forEach(b => b.classList.remove('selected'));
            if(f === 'impulskontrolle') document.getElementById('ai-f-1').classList.add('selected');
            if(f === 'frustration') document.getElementById('ai-f-2').classList.add('selected');
            if(f === 'motorik') document.getElementById('ai-f-3').classList.add('selected');
        }

        function startGame() {
            config.mode = document.getElementById('mode-select').value;
            game.players = Array.from({length: config.playerCount}, (_, i) => ({
                name: 'Tln ' + (i+1), 
                score: (config.mode.startsWith('501') ? 501 : (config.mode === '301' ? 301 : 0)),
                darts: 0, total: 0, path: []
            }));
            game.activeIdx = 0; game.timer = 45 * 60; game.history = [];
            
            document.getElementById('page-setup').classList.add('hidden');
            document.getElementById('page-game').classList.remove('hidden');
            document.getElementById('ai-top-bar').classList.remove('hidden');
            
            renderPlayers();
            startTimer();
        }

        function startTimer() {
            if(game.interval) clearInterval(game.interval);
            game.interval = setInterval(() => {
                game.timer--;
                const m = Math.floor(game.timer/60);
                const s = game.timer%60;
                document.getElementById('session-timer').innerText = `${m}:${s.toString().padStart(2,'0')}`;
                if(game.timer % 300 === 0) updateAILiveNote();
                if(game.timer <= 0) { clearInterval(game.interval); alert("Einheit beendet!"); }
            }, 1000);
        }

        function updateAILiveNote() {
            const notes = {
                impulskontrolle: ["Wurfpause einlegen?", "Ruhiges Atmen forcieren.", "N√§chster Wurf: Fokus-Check."],
                frustration: ["Positive Best√§rkung n√∂tig?", "Kleine Ziele setzen.", "Erfolgserlebnis suchen."],
                motorik: ["Standposition pr√ºfen.", "Wurfarm-Stabilit√§t?", "Gleichm√§√üiger Rhythmus."]
            };
            const f = notes[config.aiFocus];
            document.getElementById('ai-live-note').innerText = f[Math.floor(Math.random()*f.length)];
        }

        function hit(val) {
            const pts = val * game.mult;
            const p = game.players[game.activeIdx];
            
            if(config.mode.includes('501') || config.mode === '301') {
                if(p.score - pts >= 2 || p.score - pts === 0) p.score -= pts;
                if(p.score === 0) { confetti(); alert(p.name + " hat gewonnen!"); }
            } else {
                p.score += pts;
            }

            p.darts++; p.total += pts; p.path.push(p.score);
            game.turn.push(pts);
            game.history.push({pIdx: game.activeIdx, val: pts});

            if(game.turn.length === 3) {
                game.turn = [];
                game.activeIdx = (game.activeIdx + 1) % config.playerCount;
            }

            game.mult = 1;
            updateUI();
        }

        function setMult(m) {
            game.mult = m;
            document.querySelectorAll('[id^="mod-"]').forEach(b => b.classList.remove('active-mod'));
            document.getElementById('mod-'+m).classList.add('active-mod');
        }

        function renderPlayers() {
            document.getElementById('player-grid').innerHTML = game.players.map((p, i) => `
                <div class="player-card ${i===game.activeIdx?'active':''}">
                    <div class="flex justify-between text-[8px] font-black text-slate-500 uppercase mb-1">
                        <span>${p.name}</span><span>${p.darts}D</span>
                    </div>
                    <div class="text-3xl font-black text-white">${p.score}</div>
                </div>
            `).join('');
        }

        function updateUI() {
            renderPlayers();
            const divs = document.getElementById('dart-previews').children;
            for(let i=0; i<3; i++) {
                const v = game.turn[i];
                divs[i].innerText = v !== undefined ? v : "-";
                divs[i].className = `w-12 h-12 lg:w-16 lg:h-16 rounded-xl flex items-center justify-center font-black text-2xl ${v!==undefined?'bg-red-600 text-white':'glass text-slate-700'}`;
            }
            document.getElementById('turn-score').innerText = game.turn.reduce((a,b)=>a+b, 0);
            updateChart();
            
            // Checkout Helper
            const cp = game.players[game.activeIdx];
            const help = document.getElementById('checkout-help');
            if(config.mode.includes('501') && cp.score <= 170) {
                help.innerText = cp.score <= 40 && cp.score % 2 === 0 ? `Target: D${cp.score/2}` : "Finish m√∂glich";
            } else help.innerText = "";
        }

        async function openAIReport() {
            document.getElementById('report-modal').classList.remove('hidden');
            const content = document.getElementById('report-content');
            
            const prompt = `Analysiere als Dipl. Sozialp√§dagoge f√ºr die AWO KV Wesel diese Dart-Einheit. 
                Modus: ${config.mode}, Fokus: ${config.aiFocus}.
                Daten: ${JSON.stringify(game.players)}.
                Erstelle einen Bericht mit: 
                1. Beobachtungen zur ${config.aiFocus}.
                2. Soziale Interaktion & Frustlevel.
                3. Empfehlung f√ºr die Dokumentation. 
                Kurz und pr√§gnant halten.`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                content.innerHTML = `<div class="prose prose-invert prose-sm">${data.candidates[0].content.parts[0].text.replace(/\n/g, '<br>')}</div>`;
            } catch (e) { content.innerHTML = "Berichtsberechnung fehlgeschlagen. P√§dagogisches Bauchgef√ºhl nutzen!"; }
        }

        function closeReport() { document.getElementById('report-modal').classList.add('hidden'); }

        function undo() {
            if(!game.history.length) return;
            const last = game.history.pop();
            const p = game.players[last.pIdx];
            if(config.mode.includes('501') || config.mode === '301') p.score += last.val; else p.score -= last.val;
            p.darts--; p.path.pop();
            game.activeIdx = last.pIdx;
            game.turn = []; 
            updateUI();
        }

        function initNumpad() {
            const n = document.getElementById('numpad');
            [20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1].forEach(i => {
                const b = document.createElement('button');
                b.className = 'key-btn text-sm';
                b.innerText = i;
                b.onclick = () => hit(i);
                n.appendChild(b);
            });
        }

        function initChart() {
            chart = new Chart(document.getElementById('game-chart'), {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Score', data: [], borderColor: '#ef4444', tension: 0.4, fill: true, backgroundColor: 'rgba(239,68,68,0.05)' }] },
                options: { plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:false}}, responsive: true, maintainAspectRatio: false }
            });
        }

        function updateChart() {
            const p = game.players[game.activeIdx];
            chart.data.labels = p.path.map((_, i) => i);
            chart.data.datasets[0].data = p.path;
            chart.update('none');
        }
    </script>
</body>
</html>

