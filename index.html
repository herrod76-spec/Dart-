<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DART PRO AI - Full Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #020617; margin: 0; overflow: hidden; -webkit-tap-highlight-color: transparent; color: white; font-family: ui-sans-serif, system-ui, sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(16px); border: 1px solid rgba(51, 65, 85, 0.5); }
        .btn-active { transform: scale(0.95); background-color: #dc2626 !important; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .analyzing { animation: pulse-red 2s infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        const apiKey = ""; 

        const TRAINING_CATEGORIES = {
            MATCH: {
                label: "Wettkampf-Modi",
                modes: {
                    SCORING_501: { 
                        name: "501 (Double Out)", 
                        startScore: 501, 
                        instruction: "Klassisches Turnierspiel. Ziehe Punkte ab und beende das Spiel exakt auf 0 mit einem Doppel-Feld.",
                        tips: "Fördert mathematisches Verständnis und Zielgenauigkeit unter höchstem Druck." 
                    },
                    SCORING_301: { 
                        name: "301 (Single Out)", 
                        startScore: 301, 
                        instruction: "Schnelle Variante. Beende das Spiel mit einem beliebigen Treffer auf 0.",
                        tips: "Ideal für kurze pädagogische Einheiten und schnelle Erfolgserlebnisse." 
                    }
                }
            },
            EXERCISES: {
                label: "Gezielte Übungen",
                modes: {
                    BOBS_27: { 
                        name: "Bob's 27", 
                        startScore: 27, 
                        instruction: "Wirf auf Doppel 1 bis Bull. Treffer addieren Punkte, 3 Fehlwürfe ziehen den Wert ab.",
                        tips: "Trainiert das 'Double-Out'. Ein harter Modus, der Frustrationstoleranz fordert." 
                    },
                    AROUND_THE_CLOCK: { 
                        name: "Around The Clock", 
                        startScore: 0, 
                        instruction: "Triff die Segmente 1 bis 20 nacheinander. Nur Single-Treffer zählen für den Fortschritt.",
                        tips: "Perfekt zur Orientierung auf dem Board. Fördert Fokus und Koordination." 
                    },
                    SHANGHAI: { 
                        name: "Shanghai", 
                        startScore: 0, 
                        instruction: "Wirf 3 Darts auf eine Zahl. Ziel: Triff Single, Double und Triple der aktuellen Zahl (ein 'Shanghai').",
                        tips: "Spannend für Gruppen. Wer ein Shanghai wirft, gewinnt oft sofort oder sammelt massive Punkte." 
                    }
                }
            },
            ANALYSIS: {
                label: "Spezial-Analysen",
                modes: {
                    CATCH_121: { 
                        name: "121 Check", 
                        startScore: 121, 
                        instruction: "Versuche 121 Punkte mit 9 Darts (3 Aufnahmen) zu checken. Abschluss muss ein Doppel sein.",
                        tips: "Strategie-Training. Welcher Weg zum Ziel ist für den Spieler am realistischsten?" 
                    }
                }
            }
        };

        function App() {
            const [view, setView] = useState('setup');
            const [playerCount, setPlayerCount] = useState(1);
            const [selectedMode, setSelectedMode] = useState('BOBS_27');
            const [players, setPlayers] = useState([]);
            const [activeIdx, setActiveIdx] = useState(0);
            const [turnDarts, setTurnDarts] = useState([]);
            const [multiplier, setMultiplier] = useState(1);
            const [timeLeft, setTimeLeft] = useState(45 * 60);
            const [showHelp, setShowHelp] = useState(false);
            const [aiAnalysis, setAiAnalysis] = useState("");
            const [isAnalyzing, setIsAnalyzing] = useState(false);

            useEffect(() => { 
                if (window.lucide) window.lucide.createIcons(); 
            }, [view, showHelp, aiAnalysis, turnDarts]);

            const currentModeData = useMemo(() => {
                for (const cat in TRAINING_CATEGORIES) {
                    if (TRAINING_CATEGORIES[cat].modes[selectedMode]) return TRAINING_CATEGORIES[cat].modes[selectedMode];
                }
                return TRAINING_CATEGORIES.EXERCISES.modes.BOBS_27;
            }, [selectedMode]);

            const initGame = () => {
                const newPlayers = Array.from({ length: playerCount }, (_, i) => ({
                    id: i,
                    name: `Spieler ${i + 1}`,
                    score: currentModeData.startScore,
                    step: 1, // used for Bobs 27, Around Clock, Shanghai
                    dartsThrown: 0,
                    history: [],
                    isGameOver: false
                }));
                setPlayers(newPlayers);
                setAiAnalysis("");
                setView('playing');
            };

            const getAIAdvice = async () => {
                setIsAnalyzing(true);
                const stats = players.map(p => `${p.name}: ${p.score} PKT, ${p.dartsThrown} Darts`).join(", ");
                const prompt = `Analysiere als Dipl. Sozialpädagoge der AWO KV Wesel dieses Dart-Training (${currentModeData.name}): ${stats}. Gib eine kurze, motivierende Einschätzung zur Teamdynamik oder individuellen Leistung (max 2 Sätze).`;
                
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const result = await response.json();
                    setAiAnalysis(result.candidates[0].content.parts[0].text);
                } catch (error) {
                    setAiAnalysis("Konzentriert bleiben! Das Team macht Fortschritte. Weiter so!");
                } finally {
                    setIsAnalyzing(false);
                }
            };

            const processTurn = useCallback(() => {
                const updated = [...players];
                const p = updated[activeIdx];
                if (p.isGameOver) {
                    setActiveIdx((activeIdx + 1) % playerCount);
                    setTurnDarts([]);
                    return;
                }

                let turnScore = 0;

                if (selectedMode === 'BOBS_27') {
                    const target = p.step === 21 ? 25 : p.step;
                    const hits = turnDarts.filter(d => d.v === target && d.m === 2).length;
                    if (hits > 0) p.score += (hits * (target * 2));
                    else p.score -= (target * 2);
                    p.step++;
                    if (p.score <= 0 || p.step > 21) p.isGameOver = true;
                } 
                else if (selectedMode === 'AROUND_THE_CLOCK') {
                    turnDarts.forEach(d => { if(d.v === p.step) p.step++; });
                    p.score = p.step - 1; // Score displays progress
                    if (p.step > 20) p.isGameOver = true;
                }
                else if (selectedMode === 'SHANGHAI') {
                    const hits = turnDarts.filter(d => d.v === p.step);
                    const turnPoints = hits.reduce((acc, d) => acc + (d.v * d.m), 0);
                    p.score += turnPoints;
                    // Check for Shanghai (S+D+T of same number)
                    const hasS = hits.some(d => d.m === 1);
                    const hasD = hits.some(d => d.m === 2);
                    const hasT = hits.some(d => d.m === 3);
                    if (hasS && hasD && hasT) p.isGameOver = true; // Shanghai wins/ends
                    p.step++;
                    if (p.step > 20) p.isGameOver = true;
                }
                else if (selectedMode === 'CATCH_121') {
                    const turnSum = turnDarts.reduce((acc, d) => acc + (d.v * d.m), 0);
                    const lastDart = turnDarts[turnDarts.length - 1];
                    if (turnSum === p.score && lastDart.m === 2) {
                        p.score = 0;
                        p.isGameOver = true;
                    } else if (turnSum >= p.score) {
                        // Bust - no changes
                    } else {
                        p.score -= turnSum;
                    }
                    p.step++; // used here as turn counter
                    if (p.step > 3) p.isGameOver = true; // 9 Darts limit
                }
                else {
                    // Standard Scoring (501/301)
                    const turnSum = turnDarts.reduce((acc, d) => acc + (d.v * d.m), 0);
                    const lastDart = turnDarts[turnDarts.length - 1];
                    
                    if (turnSum === p.score) {
                        if (selectedMode === 'SCORING_501' && lastDart.m !== 2) {
                            // Bust if not double out
                        } else {
                            p.score = 0;
                            p.isGameOver = true;
                        }
                    } else if (turnSum > p.score || (p.score - turnSum === 1 && selectedMode === 'SCORING_501')) {
                        // Bust
                    } else {
                        p.score -= turnSum;
                    }
                }

                p.dartsThrown += 3;
                setPlayers(updated);
                setTurnDarts([]);
                setActiveIdx((activeIdx + 1) % playerCount);
            }, [turnDarts, players, activeIdx, selectedMode, playerCount]);

            useEffect(() => {
                if (turnDarts.length === 3) {
                    const t = setTimeout(processTurn, 600);
                    return () => clearTimeout(t);
                }
            }, [turnDarts, processTurn]);

            const handleInput = (val) => {
                if (turnDarts.length < 3 && currentP && !currentP.isGameOver) {
                    setTurnDarts([...turnDarts, { v: val, m: multiplier }]);
                    setMultiplier(1);
                }
            };

            if (view === 'setup') {
                return (
                    <div className="min-h-screen bg-slate-950 flex items-center justify-center p-6 relative">
                        <div className="w-full max-w-xl bg-slate-900 border border-slate-800 rounded-[3.5rem] p-12 shadow-2xl">
                            <header className="text-center mb-12">
                                <h1 className="text-6xl font-black italic uppercase tracking-tighter">DART<span className="text-red-600">PRO</span></h1>
                                <p className="text-[11px] font-bold text-slate-500 uppercase tracking-[0.4em] mt-3">AWO KV WESEL • iPad M5 Performance</p>
                            </header>
                            
                            <div className="space-y-8">
                                <section>
                                    <div className="flex justify-between items-center mb-4">
                                        <label className="text-[10px] font-black text-slate-500 uppercase">Modus</label>
                                        <button onClick={() => setShowHelp(true)} className="flex items-center gap-2 text-red-500 text-[10px] font-black uppercase hover:opacity-70">
                                            <i data-lucide="info" style={{width:14, height:14}}></i> Anleitung
                                        </button>
                                    </div>
                                    <select value={selectedMode} onChange={(e) => setSelectedMode(e.target.value)}
                                        className="w-full p-6 bg-slate-800 rounded-3xl border-2 border-slate-700 font-bold text-xl outline-none focus:border-red-600 appearance-none">
                                        {Object.entries(TRAINING_CATEGORIES).map(([ck, cat]) => (
                                            <optgroup key={ck} label={cat.label} className="bg-slate-900 text-slate-500 text-xs uppercase">
                                                {Object.entries(cat.modes).map(([mk, m]) => <option key={mk} value={mk}>{m.name}</option>)}
                                            </optgroup>
                                        ))}
                                    </select>
                                </section>

                                <section>
                                    <label className="text-[10px] font-black text-slate-500 uppercase mb-4 block">Teilnehmer</label>
                                    <div className="grid grid-cols-6 gap-3">
                                        {[1, 2, 3, 4, 5, 6].map(n => (
                                            <button key={n} onClick={() => setPlayerCount(n)} 
                                                className={`py-5 rounded-2xl font-black text-xl transition-all ${playerCount === n ? 'bg-red-600 text-white shadow-xl scale-110' : 'bg-slate-800 text-slate-500'}`}>{n}</button>
                                        ))}
                                    </div>
                                </section>

                                <button onClick={initGame} className="w-full py-7 bg-white text-black rounded-[2rem] font-black text-3xl hover:bg-red-600 hover:text-white transition-all transform active:scale-95 shadow-2xl uppercase mt-4">Starten</button>
                            </div>
                        </div>

                        {showHelp && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center p-6">
                                <div className="absolute inset-0 bg-black/90 backdrop-blur-md" onClick={() => setShowHelp(false)}></div>
                                <div className="glass w-full max-w-xl p-12 rounded-[4rem] relative z-10 animate-in fade-in zoom-in duration-300">
                                    <button onClick={() => setShowHelp(false)} className="absolute top-10 right-10 text-slate-500 hover:text-white"><i data-lucide="x"></i></button>
                                    <h2 className="text-4xl font-black uppercase italic mb-8 text-red-500 tracking-tighter">{currentModeData.name}</h2>
                                    <div className="space-y-8">
                                        <div>
                                            <label className="text-[11px] font-black text-slate-500 uppercase block mb-3 tracking-widest">Spielregeln</label>
                                            <p className="text-xl font-medium leading-relaxed text-slate-200">{currentModeData.instruction}</p>
                                        </div>
                                        <div className="p-8 bg-red-600/10 rounded-[2rem] border border-red-500/20">
                                            <label className="text-[11px] font-black text-red-500 uppercase block mb-3 tracking-widest">AWO Coach-Fokus</label>
                                            <p className="text-lg italic text-white font-medium">{currentModeData.tips}</p>
                                        </div>
                                    </div>
                                    <button onClick={() => setShowHelp(false)} className="w-full mt-10 py-5 bg-white text-black rounded-3xl font-black uppercase tracking-widest hover:bg-red-600 hover:text-white transition-colors">Alles klar</button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            const currentP = players[activeIdx];

            return (
                <div className="h-screen bg-slate-950 flex flex-col overflow-hidden font-sans">
                    <header className="bg-slate-900/50 backdrop-blur-lg px-10 py-5 border-b border-white/5 flex justify-between items-center shrink-0 z-10">
                        <button onClick={() => setView('setup')} className="text-slate-500 hover:text-white transition-colors"><i data-lucide="home" style={{width:28, height:28}}></i></button>
                        <div className="flex items-center gap-6 bg-black/40 px-8 py-3 rounded-full border border-white/10 shadow-2xl">
                            <i data-lucide="clock" className="text-red-600" style={{width:20, height:20}}></i>
                            <span className="text-3xl font-black tabular-nums tracking-tighter">
                                {Math.floor(timeLeft/60)}:{(timeLeft%60).toString().padStart(2, '0')}
                            </span>
                        </div>
                        <button onClick={getAIAdvice} className={`flex items-center gap-3 px-6 py-3 rounded-full border-2 transition-all ${isAnalyzing ? 'border-red-600 text-red-600 analyzing' : 'border-slate-800 text-slate-400 hover:text-white hover:border-white'}`}>
                            <i data-lucide="sparkles" style={{width:18, height:18}}></i>
                            <span className="text-xs font-black uppercase tracking-widest">KI Analyse</span>
                        </button>
                    </header>

                    <div className="flex flex-1 overflow-hidden relative">
                        {aiAnalysis && (
                            <div className="absolute top-6 left-1/2 -translate-x-1/2 w-[90%] max-w-2xl z-50 animate-in slide-in-from-top duration-500">
                                <div className="glass p-8 rounded-[3rem] border-red-500/40 shadow-[0_30px_60px_-12px_rgba(0,0,0,0.5)] relative">
                                    <button onClick={() => setAiAnalysis("")} className="absolute top-6 right-8 text-slate-500"><i data-lucide="x" style={{width:20, height:20}}></i></button>
                                    <div className="flex gap-6 items-start">
                                        <div className="bg-red-600 p-4 rounded-2xl shadow-lg shadow-red-900/40"><i data-lucide="bot" style={{width:28, height:28}}></i></div>
                                        <div>
                                            <div className="text-[10px] font-black text-red-500 uppercase tracking-widest mb-2">Dipl. Sozialpädagoge KI</div>
                                            <p className="text-lg font-bold italic leading-tight text-white">{aiAnalysis}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        <aside className="w-80 bg-slate-900/20 border-r border-white/5 p-8 space-y-4 overflow-y-auto">
                            {players.map((p, idx) => (
                                <div key={p.id} className={`p-7 rounded-[2.5rem] border-2 transition-all duration-500 ${idx === activeIdx ? 'bg-red-600/20 border-red-600 scale-105 shadow-2xl shadow-red-900/20' : 'bg-slate-800/10 border-transparent opacity-30'}`}>
                                    <div className="flex justify-between items-start mb-2">
                                        <div className="text-[10px] font-black text-slate-500 uppercase tracking-widest">{p.name}</div>
                                        {p.isGameOver && <i data-lucide="check-circle" className="text-green-500" style={{width:14, height:14}}></i>}
                                    </div>
                                    <div className="text-5xl font-black italic tracking-tighter">{p.score}</div>
                                    <div className="mt-3 flex gap-2">
                                        <span className="text-[9px] font-black bg-slate-800 px-2 py-1 rounded text-slate-400 uppercase">Darts: {p.dartsThrown}</span>
                                        {selectedMode !== 'SCORING_501' && <span className="text-[9px] font-black bg-red-900/30 px-2 py-1 rounded text-red-400 uppercase">Runde: {p.step}</span>}
                                    </div>
                                </div>
                            ))}
                        </aside>

                        <main className="flex-1 p-12 flex flex-col items-center justify-center relative bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-slate-900/50 via-slate-950 to-slate-950">
                            <div className="text-[14rem] md:text-[18rem] font-black italic leading-none tracking-tighter drop-shadow-[0_25px_60px_rgba(220,38,38,0.2)]">
                                {currentP?.score}
                            </div>

                            <div className="h-20 mb-10 flex flex-col items-center justify-center">
                                {currentP && !currentP.isGameOver && (
                                    <div className="bg-red-600 px-12 py-4 rounded-full text-3xl font-black uppercase italic shadow-2xl animate-pulse">
                                        {selectedMode === 'BOBS_27' && `Ziel: D${currentP.step === 21 ? 'Bull' : currentP.step}`}
                                        {selectedMode === 'AROUND_THE_CLOCK' && `Triff: ${currentP.step}`}
                                        {selectedMode === 'SHANGHAI' && `Feld: ${currentP.step}`}
                                        {selectedMode === 'CATCH_121' && `Check: ${currentP.score}`}
                                        {(selectedMode === 'SCORING_501' || selectedMode === 'SCORING_301') && `Rest: ${currentP.score}`}
                                    </div>
                                )}
                                {currentP?.isGameOver && <div className="text-green-500 text-4xl font-black uppercase italic italic">Fertig!</div>}
                            </div>

                            <div className="flex gap-6 mb-12">
                                {[0, 1, 2].map(i => (
                                    <div key={i} className={`w-24 h-32 md:w-28 md:h-40 rounded-[2rem] border-4 flex items-center justify-center text-5xl font-black transition-all duration-300 ${turnDarts[i] ? 'bg-red-600 border-red-400 shadow-[0_0_50px_rgba(220,38,38,0.5)] scale-110 text-white' : 'bg-slate-900 border-slate-800/50 text-slate-800 opacity-20'}`}>
                                        {turnDarts[i] ? `${turnDarts[i].m === 2 ? 'D' : turnDarts[i].m === 3 ? 'T' : ''}${turnDarts[i].v === 25 ? 'B' : turnDarts[i].v}` : ''}
                                    </div>
                                ))}
                            </div>

                            <div className="w-full max-w-3xl grid grid-cols-4 gap-6">
                                <div className="flex flex-col gap-3">
                                    {[1, 2, 3].map(m => (
                                        <button key={m} onClick={() => setMultiplier(m)} 
                                            className={`flex-1 rounded-[1.5rem] font-black border-4 transition-all duration-200 ${multiplier === m ? 'bg-white text-black border-white shadow-xl scale-105' : 'bg-slate-900 border-slate-800 text-slate-600 text-xs tracking-widest uppercase'}`}>
                                            {m === 1 ? 'SINGLE' : m === 2 ? 'DOUBLE' : 'TRIPLE'}
                                        </button>
                                    ))}
                                </div>
                                <div className="col-span-3 grid grid-cols-7 gap-3">
                                    {[20, 19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1].map(n => (
                                        <button key={n} onClick={() => handleInput(n)} 
                                            className="bg-slate-900 border border-white/5 rounded-2xl py-5 md:py-6 font-black text-2xl md:text-3xl hover:bg-red-600 hover:scale-105 active:bg-white active:text-black transition-all shadow-xl">{n}</button>
                                    ))}
                                    <button onClick={() => handleInput(25)} className="bg-red-900/40 border border-red-500/50 text-red-500 rounded-2xl font-black text-sm uppercase hover:bg-red-600 hover:text-white transition-all">Bull</button>
                                    <button onClick={() => handleInput(0)} className="bg-slate-950 border border-white/5 text-slate-700 rounded-2xl font-black text-sm uppercase hover:bg-slate-800 transition-all">Miss</button>
                                </div>
                            </div>
                        </main>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

